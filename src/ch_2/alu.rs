use super::adder::add16;
use crate::ch_1::{and16, mux16, not, not16, or, or8way, Bit, Bit16};

#[derive(Debug, PartialEq, Eq)]
pub struct ALUOutput {
    pub out: Bit16,
    pub zr: Bit,
    pub ng: Bit,
}
impl From<(Bit16, Bit, Bit)> for ALUOutput {
    fn from(v: (Bit16, Bit, Bit)) -> Self {
        Self {
            out: v.0,
            zr: v.1,
            ng: v.2,
        }
    }
}

type ALUInput = (Bit16, Bit16);
type ALUSelector = (Bit, Bit, Bit, Bit, Bit, Bit);

#[allow(dead_code)]
pub fn alu(input: ALUInput, selector: ALUSelector) -> ALUOutput {
    let (x, y) = input;
    let (zx, nx, zy, ny, f, no) = selector;
    // if zx then x = 0
    let x = mux16(&x, &[0; 16], zx);
    // if nx then x = !x
    let x = mux16(&x, &not16(&x), nx);
    // if zy then y = 0
    let y = mux16(&y, &[0; 16], zy);
    // if ny then y = !y
    let y = mux16(&y, &not16(&y), ny);
    // if f then out = x + y
    //      else out = x & y
    let out = mux16(&and16(&x, &y), &add16(x, y), f);
    // if no then out = !out
    let out = mux16(&out, &not16(&out), no);
    // if out=0 then zr = 1 else zr = 0
    let zr = not(or(
        or8way(&[
            out[0], out[1], out[2], out[3], out[4], out[5], out[6], out[7],
        ]),
        or8way(&[
            out[8], out[9], out[10], out[11], out[12], out[13], out[14], out[15],
        ]),
    ));
    // if out<0 then ng = 1 else ng = 0
    let ng = out[0];
    (out, zr, ng).into()
}

#[cfg(test)]
mod tests {
    use super::*;

    macro_rules! test_alu {
        ($(case(| $x:literal | $y:literal | $zx:literal | $nx:literal | $zy:literal | $ny:literal | $f:literal | $no:literal | $out:literal |))+) => {
            $(#[case($x, $y, ($zx, $nx, $zy, $ny, $f, $no), $out)])+
            fn test_alu(x: &str, y: &str, selector: ALUSelector, out: &str) {
                assert_eq!(alu((bit!(16, x), bit!(16, y)), selector).out, bit!(16, out));
            }
        };
    }

    test_alu!(
        case(| "0000000000000000" | "1111111111111111" | 1 | 0 | 1 | 0 | 1 | 0 | "0000000000000000" |)
        case(| "0000000000000000" | "1111111111111111" | 1 | 1 | 1 | 1 | 1 | 1 | "0000000000000001" |)
        case(| "0000000000000000" | "1111111111111111" | 1 | 1 | 1 | 0 | 1 | 0 | "1111111111111111" |)
        case(| "0000000000000000" | "1111111111111111" | 0 | 0 | 1 | 1 | 0 | 0 | "0000000000000000" |)
        case(| "0000000000000000" | "1111111111111111" | 1 | 1 | 0 | 0 | 0 | 0 | "1111111111111111" |)
        case(| "0000000000000000" | "1111111111111111" | 0 | 0 | 1 | 1 | 0 | 1 | "1111111111111111" |)
        case(| "0000000000000000" | "1111111111111111" | 1 | 1 | 0 | 0 | 0 | 1 | "0000000000000000" |)
        case(| "0000000000000000" | "1111111111111111" | 0 | 0 | 1 | 1 | 1 | 1 | "0000000000000000" |)
        case(| "0000000000000000" | "1111111111111111" | 1 | 1 | 0 | 0 | 1 | 1 | "0000000000000001" |)
        case(| "0000000000000000" | "1111111111111111" | 0 | 1 | 1 | 1 | 1 | 1 | "0000000000000001" |)
        case(| "0000000000000000" | "1111111111111111" | 1 | 1 | 0 | 1 | 1 | 1 | "0000000000000000" |)
        case(| "0000000000000000" | "1111111111111111" | 0 | 0 | 1 | 1 | 1 | 0 | "1111111111111111" |)
        case(| "0000000000000000" | "1111111111111111" | 1 | 1 | 0 | 0 | 1 | 0 | "1111111111111110" |)
        case(| "0000000000000000" | "1111111111111111" | 0 | 0 | 0 | 0 | 1 | 0 | "1111111111111111" |)
        case(| "0000000000000000" | "1111111111111111" | 0 | 1 | 0 | 0 | 1 | 1 | "0000000000000001" |)
        case(| "0000000000000000" | "1111111111111111" | 0 | 0 | 0 | 1 | 1 | 1 | "1111111111111111" |)
        case(| "0000000000000000" | "1111111111111111" | 0 | 0 | 0 | 0 | 0 | 0 | "0000000000000000" |)
        case(| "0000000000000000" | "1111111111111111" | 0 | 1 | 0 | 1 | 0 | 1 | "1111111111111111" |)
        case(| "0101101110100000" | "0001111011010010" | 1 | 0 | 1 | 0 | 1 | 0 | "0000000000000000" |)
        case(| "0101101110100000" | "0001111011010010" | 1 | 1 | 1 | 1 | 1 | 1 | "0000000000000001" |)
        case(| "0101101110100000" | "0001111011010010" | 1 | 1 | 1 | 0 | 1 | 0 | "1111111111111111" |)
        case(| "0101101110100000" | "0001111011010010" | 0 | 0 | 1 | 1 | 0 | 0 | "0101101110100000" |)
        case(| "0101101110100000" | "0001111011010010" | 1 | 1 | 0 | 0 | 0 | 0 | "0001111011010010" |)
        case(| "0101101110100000" | "0001111011010010" | 0 | 0 | 1 | 1 | 0 | 1 | "1010010001011111" |)
        case(| "0101101110100000" | "0001111011010010" | 1 | 1 | 0 | 0 | 0 | 1 | "1110000100101101" |)
        case(| "0101101110100000" | "0001111011010010" | 0 | 0 | 1 | 1 | 1 | 1 | "1010010001100000" |)
        case(| "0101101110100000" | "0001111011010010" | 1 | 1 | 0 | 0 | 1 | 1 | "1110000100101110" |)
        case(| "0101101110100000" | "0001111011010010" | 0 | 1 | 1 | 1 | 1 | 1 | "0101101110100001" |)
        case(| "0101101110100000" | "0001111011010010" | 1 | 1 | 0 | 1 | 1 | 1 | "0001111011010011" |)
        case(| "0101101110100000" | "0001111011010010" | 0 | 0 | 1 | 1 | 1 | 0 | "0101101110011111" |)
        case(| "0101101110100000" | "0001111011010010" | 1 | 1 | 0 | 0 | 1 | 0 | "0001111011010001" |)
        case(| "0101101110100000" | "0001111011010010" | 0 | 0 | 0 | 0 | 1 | 0 | "0111101001110010" |)
        case(| "0101101110100000" | "0001111011010010" | 0 | 1 | 0 | 0 | 1 | 1 | "0011110011001110" |)
        case(| "0101101110100000" | "0001111011010010" | 0 | 0 | 0 | 1 | 1 | 1 | "1100001100110010" |)
        case(| "0101101110100000" | "0001111011010010" | 0 | 0 | 0 | 0 | 0 | 0 | "0001101010000000" |)
        case(| "0101101110100000" | "0001111011010010" | 0 | 1 | 0 | 1 | 0 | 1 | "0101111111110010" |)
    );
}
